<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-section set-bg" data-setbg="/img/breadcrumb.jpg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="breadcrumb__text">
                    <h2>Thanh toán</h2>
                    <div class="breadcrumb__option">
                        <a href="/">Trang chủ</a>
                        <a href="/cart">Giỏ hàng</a>
                        <span>Thanh toán</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h6><span class="icon_tag_alt"></span> Bạn có mã giảm giá? <a href="#">Nhấn vào đây</a> để nhập mã
                </h6>
            </div>
        </div>
        <div class="checkout__form">
            <h4>Thông tin thanh toán</h4>
            <form action="/order/place-order" method="POST">
                <div class="row">
                    <div class="col-lg-7 col-md-6">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Họ tên<span>*</span></p>
                                    <input type="text" name="receiverName" value="{{userInfo.fullName}}" required>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="checkout__input">
                                    <p>Số điện thoại<span>*</span></p>
                                    <input type="text" name="phoneNumber" value="{{userInfo.phoneNumber}}" required>
                                </div>
                            </div>
                        </div>
                        <div class="checkout__input">
                            <p>Địa chỉ<span>*</span></p>
                            <input type="text" name="address" placeholder="Địa chỉ giao hàng"
                                value="{{userInfo.address}}" required>
                        </div>
                        <div class="checkout__input">
                            <p>Ghi chú đơn hàng</p>
                            <input type="text" name="note"
                                placeholder="Ghi chú về đơn hàng của bạn, ví dụ: ghi chú đặc biệt cho việc giao hàng.">
                        </div>
                        <div class="checkout__input">
                            <p>Phương thức vận chuyển<span>*</span></p>
                            <div class="checkout__input__checkbox">
                                <label for="standard">
                                    Tiêu chuẩn (30.000đ)
                                    <input type="radio" id="standard" name="shippingMethod" value="Standard" checked>
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <div class="checkout__input__checkbox">
                                <label for="express">
                                    Nhanh (50.000đ)
                                    <input type="radio" id="express" name="shippingMethod" value="Express">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div>
                        <div class="checkout__input">
                            <p>Phương thức thanh toán<span>*</span></p>
                            <div class="checkout__input__checkbox">
                                <label for="cod">
                                    Thanh toán khi nhận hàng (COD)
                                    <input type="radio" id="cod" name="paymentMethod" value="COD" checked>
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <div class="checkout__input__checkbox">
                                <label for="banking">
                                    Chuyển khoản ngân hàng
                                    <input type="radio" id="banking" name="paymentMethod" value="Banking">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-6">
                        <div class="checkout__order">
                            <h4>Đơn hàng của bạn</h4>
                            <div class="checkout__order__products">Sản phẩm <span>Thành tiền</span></div>
                            <ul>
                                {{#each cartItems}}
                                <li>{{this.title}} (x{{this.quantity}}) <span>{{formatCurrency this.total}}</span></li>
                                {{/each}}
                            </ul>
                            <div class="checkout__order__subtotal">Tạm tính <span>{{formatCurrency subtotal}}</span>
                            </div>
                            <div class="checkout__order__subtotal">VAT (10%) <span>{{formatCurrency vat}}</span></div>
                            <div class="checkout__order__subtotal">Phí vận chuyển <span
                                    class="shipping-fee">{{formatCurrency shippingFee}}</span></div>
                            <div class="checkout__order__total">Tổng cộng <span class="total-amount">{{formatCurrency
                                    totalAmount}}</span></div>
                            <button type="submit" class="site-btn">ĐẶT HÀNG</button>
                        </div>
                    </div>
                </div>
        </div>
        </form>
    </div>
    </div>
</section>
<!-- Checkout Section End -->

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ==================== PHẦN 1: CẬP NHẬT PHÍ VẬN CHUYỂN ====================
    const shippingRadios = document.querySelectorAll('input[name="shippingMethod"]');
    const shippingFeeEl = document.querySelector('.checkout__order__subtotal span.shipping-fee');
    const totalAmountEl = document.querySelector('.checkout__order__total span.total-amount');
    const subtotal = {{subtotal}};
    const vat = {{vat}};
    const FREE_SHIPPING_THRESHOLD = 100000;

    // Format tiền tệ
    const formatCurrency = (number) => new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND' 
    }).format(number);

    // Cập nhật phí vận chuyển và tổng tiền
    function updateShippingFees() {
        let shippingFee = 30000; // Phí tiêu chuẩn
        
        // Kiểm tra nếu chọn giao nhanh
        if (document.getElementById('express')?.checked) {
            shippingFee = 50000;
        }
        
        // Miễn phí nếu đơn hàng >= 100k
        if (subtotal >= FREE_SHIPPING_THRESHOLD) {
            shippingFee = 0;
            updateShippingLabels('Miễn phí');
        }

        const totalAmount = subtotal + vat + shippingFee;
        
        // Cập nhật UI
        if (shippingFeeEl) shippingFeeEl.textContent = formatCurrency(shippingFee);
        if (totalAmountEl) totalAmountEl.textContent = formatCurrency(totalAmount);
    }

    // Cập nhật label radio button với text động
    function updateShippingLabels(feeText) {
        const standardLabel = document.querySelector('label[for="standard"]');
        const expressLabel = document.querySelector('label[for="express"]');
        
        if (standardLabel) {
            standardLabel.innerHTML = `Tiêu chuẩn (${feeText}) <input type="radio" id="standard" name="shippingMethod" value="Standard" checked><span class="checkmark"></span>`;
        }
        if (expressLabel) {
            expressLabel.innerHTML = `Nhanh (${feeText}) <input type="radio" id="express" name="shippingMethod" value="Express"><span class="checkmark"></span>`;
        }
    }

    // Gắn sự kiện thay đổi phương thức vận chuyển
    shippingRadios.forEach(radio => radio.addEventListener('change', updateShippingFees));
    
    // Khởi tạo lần đầu
    updateShippingFees();

    // ==================== PHẦN 2: VALIDATION FORM CHỐNG XSS ====================
    const checkoutForm = document.querySelector('form[action*="/order/place"]');
    
    if (!checkoutForm) return; // Không có form thì dừng

    // Các pattern nguy hiểm
    const DANGEROUS_PATTERNS = {
        xss: /<script|<\/script|javascript:|onerror=|onload=|<iframe|onclick=|eval\(|expression\(/i,
        html: /<[^>]+>/g
    };

    // Config validation cho từng field
    const FIELD_RULES = {
        receiverName: {
            selector: 'input[name="receiverName"]',
            maxLength: 100,
            label: 'Tên người nhận'
        },
        address: {
            selector: 'input[name="address"]',
            maxLength: 200,
            label: 'Địa chỉ'
        },
        phoneNumber: {
            selector: 'input[name="phoneNumber"]',
            maxLength: 15,
            label: 'Số điện thoại',
            pattern: /^[0-9+\-\s()]+$/,
            patternError: 'Số điện thoại chỉ được chứa số và ký tự +, -, (, )'
        },
        note: {
            selector: 'textarea[name="note"]',
            maxLength: 500,
            label: 'Ghi chú',
            required: false
        }
    };

    // Hàm hiển thị lỗi
    const showError = (message) => {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: message,
                confirmButtonColor: '#7fad39'
            });
        } else {
            alert(message);
        }
    };

    // Validate một field
    function validateField(fieldName, value) {
        const rule = FIELD_RULES[fieldName];
        
        // Bỏ qua nếu field không bắt buộc và rỗng
        if (!rule.required && !value) return true;

        // Kiểm tra XSS
        if (DANGEROUS_PATTERNS.xss.test(value)) {
            showError(`${rule.label} chứa ký tự không hợp lệ!`);
            return false;
        }

        // Kiểm tra độ dài
        if (value.length > rule.maxLength) {
            showError(`${rule.label} quá dài (tối đa ${rule.maxLength} ký tự)!`);
            return false;
        }

        // Kiểm tra pattern riêng (ví dụ: số điện thoại)
        if (rule.pattern && !rule.pattern.test(value)) {
            showError(rule.patternError || `${rule.label} không đúng định dạng!`);
            return false;
        }

        return true;
    }

    // Validate toàn bộ form
    function validateForm(e) {
        // Lấy giá trị các field
        const formData = {};
        let isValid = true;

        for (const [fieldName, rule] of Object.entries(FIELD_RULES)) {
            const input = document.querySelector(rule.selector);
            const value = input?.value?.trim() || '';
            
            formData[fieldName] = value;

            // Validate từng field
            if (!validateField(fieldName, value)) {
                e.preventDefault();
                isValid = false;
                
                // Focus vào field lỗi
                if (input) {
                    input.focus();
                    input.classList.add('error');
                    setTimeout(() => input.classList.remove('error'), 2000);
                }
                
                break; // Dừng lại ở lỗi đầu tiên
            }
        }

        // Log nếu có lỗi (để debug)
        if (!isValid) {
            console.warn('Form validation failed:', formData);
        }

        return isValid;
    }

    // Gắn sự kiện submit
    checkoutForm.addEventListener('submit', validateForm);

    // Validation realtime (tùy chọn)
    Object.entries(FIELD_RULES).forEach(([fieldName, rule]) => {
        const input = document.querySelector(rule.selector);
        if (input) {
            input.addEventListener('blur', function() {
                const value = this.value.trim();
                if (value) {
                    validateField(fieldName, value);
                }
            });
        }
    });
});
</script>

<style>
/* Style cho field bị lỗi */
input.error, textarea.error {
    border: 2px solid #dc3545 !important;
    animation: shake 0.3s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
</style>